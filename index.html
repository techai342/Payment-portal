<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Payment Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #000; min-height: 100vh; }
        .bg-img {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://ik.imagekit.io/shaban/SHABAN-1768916053366_fxqIWiUP-.jpg');
            background-size: cover; background-position: center; opacity: 0.75; z-index: -1;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border-radius: 2rem;
        }
        .input-field {
            background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; border-radius: 1rem; transition: 0.3s;
        }
        .input-field:focus { border-color: #f97316; outline: none; background: rgba(0, 0, 0, 0.7); }
        .rgb-text {
            text-shadow: 0 0 10px rgba(249, 115, 22, 0.8), 0 0 20px rgba(59, 130, 246, 0.5);
            animation: pulse 3s infinite;
        }
        @keyframes pulse { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(15deg); } }
        .hidden { display: none; }
        .copy-btn {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            color: #f97316;
            transition: all 0.2s;
        }
        .copy-btn:active { transform: scale(0.9); background: #f97316; color: white; }
    </style>
</head>
<body class="font-sans text-white">
    <div class="bg-img"></div>

    <!-- Logout Button (Floating top right) -->
    <div id="navBar" class="fixed top-4 right-4 z-50 hidden">
        <button onclick="handleLogout()" class="bg-red-600/20 hover:bg-red-600 border border-red-500/50 px-4 py-2 rounded-lg text-xs font-bold uppercase transition-all shadow-lg">Logout</button>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 hidden px-6 py-3 rounded-xl font-bold text-center shadow-2xl text-white"></div>

    <div class="min-h-screen flex items-center justify-center p-4">
        
        <!-- 1. AUTH SCREEN -->
        <div id="authScreen" class="glass-card p-8 w-full max-w-md text-center">
            <h1 class="text-3xl font-black text-orange-500 rgb-text italic mb-2 uppercase">kachu ARMY</h1>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-8">Tournament Gate Pass</p>

            <div id="signupForm" class="space-y-4">
                <input type="text" id="regName" placeholder="Full Name" class="w-full p-4 input-field font-bold">
                <input type="tel" id="regPhone" placeholder="Phone Number (Login ID)" class="w-full p-4 input-field font-bold">
                <input type="password" id="regPass" placeholder="Create Password" class="w-full p-4 input-field font-bold">
                <button onclick="handleSignup()" class="w-full bg-orange-600 hover:bg-orange-500 py-4 rounded-xl font-black uppercase tracking-widest transition-all">Register Now</button>
                <p class="text-xs mt-4 text-slate-400 cursor-pointer hover:text-white" onclick="toggleAuth('login')">Already registered? Login</p>
            </div>

            <div id="loginForm" class="space-y-4 hidden">
                <input type="tel" id="loginPhone" placeholder="Phone Number" class="w-full p-4 input-field font-bold">
                <input type="password" id="loginPass" placeholder="Password" class="w-full p-4 input-field font-bold">
                <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black uppercase tracking-widest transition-all">Login</button>
                <p class="text-xs mt-4 text-slate-400 cursor-pointer hover:text-white" onclick="toggleAuth('signup')">New User? Register</p>
            </div>
        </div>

        <!-- 2. PAYMENT SUBMISSION SCREEN -->
        <div id="paymentScreen" class="glass-card p-8 w-full max-w-lg hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-white uppercase italic">Bank Transfer Details</h2>
                <p class="text-slate-400 text-xs mt-1">Send Payment to Bank Account</p>
            </div>

            <!-- Bank Account Details (RE-ADDED) -->
            <div class="bg-white/5 p-6 rounded-2xl mb-6 border border-white/10 text-left">
                <p class="text-[10px] text-orange-500 font-black uppercase tracking-widest mb-4">Account Information</p>
                <div class="space-y-3">
                    <div class="flex"><span class="text-xs text-slate-400 font-bold w-40">Account Holder:</span><span class="text-sm font-bold text-white">Muhammad Fahad Ali</span></div>
                    <div class="flex"><span class="text-xs text-slate-400 font-bold w-40">Bank Name:</span><span class="text-sm font-bold text-white">Askari Bank Limited</span></div>
                    <div class="flex"><span class="text-xs text-slate-400 font-bold w-40">Branch:</span><span class="text-sm font-bold text-white">IBB Circular Road Branch, Lahore</span></div>
                    <div class="flex"><span class="text-xs text-slate-400 font-bold w-40">Account Number:</span><span class="text-sm font-bold text-white">07060200020269</span></div>
                    <div class="flex"><span class="text-xs text-slate-400 font-bold w-40">IBAN:</span><span class="text-sm font-bold text-white break-all">PK34ASCM0007060200020269</span></div>
                </div>
                <div class="mt-6 pt-6 border-t border-white/10 text-center">
                    <p class="text-xs text-slate-400 mb-2">Scan QR to get bank details</p>
                    <div class="bg-white p-2 w-32 h-32 mx-auto rounded-lg flex items-center justify-center">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Bank%20Details%3A%0AAccount%20Holder%3A%20Muhammad%20Fahad%20Ali%0ABank%3A%20Askari%20Bank%20Limited%0AIBAN%3A%20PK34ASCM0007060200020269%0AAC%2FNo%3A%2007060200020269" alt="QR Code" class="w-full h-full object-cover">
                    </div>
                </div>
            </div>

            <form id="payForm" class="space-y-4">
                <select id="payMethod" class="w-full p-4 input-field font-bold bg-black">
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Easypaisa">Easypaisa</option>
                    <option value="JazzCash">JazzCash</option>
                </select>
                <input type="text" id="senderName" placeholder="Your Account Name" class="w-full p-4 input-field font-bold" required>
                <input type="text" id="trxId" placeholder="Transaction Reference / TRX ID" class="w-full p-4 input-field font-bold" required>
                <div class="relative border-2 border-dashed border-slate-600 rounded-xl p-4 text-center cursor-pointer hover:border-orange-500 transition-all">
                    <input type="file" id="screenshot" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewImage(this)">
                    <p id="fileLabel" class="text-xs font-bold text-slate-400 uppercase">Upload Payment Screenshot</p>
                    <img id="imgPrev" class="hidden mt-2 max-h-32 mx-auto rounded-lg">
                </div>
                <button type="submit" id="submitPayBtn" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-black uppercase tracking-widest transition-all">Verify Payment</button>
            </form>
        </div>

        <!-- 3. PENDING SCREEN -->
        <div id="pendingScreen" class="glass-card p-10 w-full max-w-md text-center hidden">
            <div class="w-20 h-20 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
            <h2 class="text-2xl font-black text-white uppercase mb-2">Payment Under Review</h2>
            <p class="text-slate-400 text-sm font-bold">Admin aapki payment check kar raha hai. Refresh karne ki zaroorat nahi, hum record save rakhengy.</p>
            <button onclick="checkLatestStatus()" class="mt-8 bg-white/10 hover:bg-white/20 px-6 py-3 rounded-xl font-bold text-xs uppercase">Check Status Now</button>
        </div>

        <!-- 4. SUCCESS SCREEN -->
        <div id="successScreen" class="glass-card p-8 w-full max-w-md text-center hidden relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-orange-500"></div>
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-[0_0_20px_#22c55e]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h2 class="text-3xl font-black text-white italic uppercase mb-1">Access Granted</h2>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-6">Your Slot is Confirmed!</p>
            <div class="bg-black/40 p-6 rounded-2xl border border-white/10 mb-6 text-left relative">
                <p class="text-[10px] font-black text-orange-500 uppercase mb-4">Assigned Credentials</p>
                <div class="flex justify-between items-center mb-4 pb-4 border-b border-white/5">
                    <div><span class="text-[10px] text-slate-500 block uppercase">Username</span><span id="displayUser" class="font-mono font-black text-xl text-white">---</span></div>
                    <button onclick="copyField('displayUser', 'Username')" class="copy-btn">COPY</button>
                </div>
                <div class="flex justify-between items-center">
                    <div><span class="text-[10px] text-slate-500 block uppercase">Password</span><span id="displayPass" class="font-mono font-black text-xl text-white tracking-widest">---</span></div>
                    <button onclick="copyField('displayPass', 'Password')" class="copy-btn">COPY</button>
                </div>
                <input type="hidden" id="hiddenUser"><input type="hidden" id="hiddenPass">
            </div>
            <button onclick="goToSquadPortal()" class="w-full bg-orange-600 hover:bg-orange-500 py-5 rounded-2xl font-black uppercase text-lg shadow-xl shadow-orange-600/20 active:scale-95 transition-all flex items-center justify-center gap-2">Access Squad Portal</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://psiypllbqopudppugaxe.supabase.co"; 
        const SB_KEY = "sb_publishable_PsL-7tSFu4EQU5ZHQgO6UA_Segl7g_e";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        
        let currentUser = null;

        // Session Persistence
        window.onload = function() {
            const session = localStorage.getItem('k_army_user');
            if(session) {
                currentUser = JSON.parse(session);
                checkStatus(true); // Silent status check
            }
        };

        function saveSession(user) {
            localStorage.setItem('k_army_user', JSON.stringify(user));
        }

        function handleLogout() {
            localStorage.removeItem('k_army_user');
            currentUser = null;
            location.reload();
        }

        function toast(msg, color='bg-green-600') {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `fixed top-5 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-xl font-bold text-center shadow-2xl text-white ${color}`;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        function toggleAuth(type) {
            document.getElementById('signupForm').classList.toggle('hidden', type === 'login');
            document.getElementById('loginForm').classList.toggle('hidden', type === 'signup');
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imgPrev').src = e.target.result;
                    document.getElementById('imgPrev').classList.remove('hidden');
                    document.getElementById('fileLabel').innerText = "Image Selected";
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function copyToClipboard(text) {
            const dummy = document.createElement("textarea");
            document.body.appendChild(dummy);
            dummy.value = text;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
        }

        function copyField(id, label) {
            copyToClipboard(document.getElementById(id).innerText);
            toast(label + " Copied!");
        }

        async function handleSignup() {
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const pass = document.getElementById('regPass').value;
            if(!name || !phone || !pass) return toast("Fill all fields!", "bg-red-600");

            const { data, error } = await supabaseClient.from('payment_users').insert([{
                full_name: name, phone_number: phone, password: pass, status: 'new'
            }]).select();

            if(error) return toast(error.message, "bg-red-600");
            currentUser = data[0];
            saveSession(currentUser);
            showScreen('paymentScreen');
            document.getElementById('navBar').classList.remove('hidden');
        }

        async function handleLogin() {
            const phone = document.getElementById('loginPhone').value;
            const pass = document.getElementById('loginPass').value;
            const { data, error } = await supabaseClient.from('payment_users').select('*').eq('phone_number', phone).eq('password', pass).single();

            if(error || !data) return toast("Invalid Credentials", "bg-red-600");
            currentUser = data;
            saveSession(currentUser);
            checkStatus();
        }

        async function checkLatestStatus() {
            const { data } = await supabaseClient.from('payment_users').select('*').eq('id', currentUser.id).single();
            if(data) {
                currentUser = data;
                saveSession(currentUser);
                checkStatus();
                toast("Status Updated!");
            }
        }

        function checkStatus(silent = false) {
            if(!currentUser) return;
            document.getElementById('navBar').classList.remove('hidden');
            
            if(currentUser.status === 'new') showScreen('paymentScreen');
            else if(currentUser.status === 'pending') showScreen('pendingScreen');
            else if(currentUser.status === 'approved') fetchAssignedCreds(false);
            else if(currentUser.status === 'rejected') toast("Application Rejected", "bg-red-600");
            
            if(!silent) toast("Welcome Back!");
        }

        async function fetchAssignedCreds() {
            if(!currentUser.assigned_auth_id) return showScreen('pendingScreen');
            const { data } = await supabaseClient.from('squad_auth').select('password').eq('user_id', currentUser.assigned_auth_id).single();
            
            document.getElementById('displayUser').innerText = currentUser.assigned_auth_id;
            document.getElementById('displayPass').innerText = data ? data.password : "---";
            document.getElementById('hiddenUser').value = currentUser.assigned_auth_id;
            document.getElementById('hiddenPass').value = data ? data.password : "";
            showScreen('successScreen');
        }

        function showScreen(id) {
            ['authScreen', 'paymentScreen', 'pendingScreen', 'successScreen'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        document.getElementById('payForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitPayBtn');
            btn.disabled = true; btn.innerText = "Uploading...";

            const file = document.getElementById('screenshot').files[0];
            const fileName = `${Date.now()}_${currentUser.phone_number}`;
            const { error: imgError } = await supabaseClient.storage.from('payment_proofs').upload(fileName, file);

            if(imgError) { btn.disabled = false; return toast("Upload Failed", "bg-red-600"); }

            const imgUrl = `https://psiypllbqopudppugaxe.supabase.co/storage/v1/object/public/payment_proofs/${fileName}`;
            const { error: dbError } = await supabaseClient.from('payment_users').update({
                payment_method: document.getElementById('payMethod').value,
                account_name: document.getElementById('senderName').value,
                trx_id: document.getElementById('trxId').value,
                screenshot_url: imgUrl,
                status: 'pending'
            }).eq('id', currentUser.id);

            if(!dbError) {
                currentUser.status = 'pending';
                saveSession(currentUser);
                showScreen('pendingScreen');
            }
        };

        function goToSquadPortal() {
            const creds = `ID: ${document.getElementById('hiddenUser').value}\nPass: ${document.getElementById('hiddenPass').value}`;
            copyToClipboard(creds);
            toast("Copied! Opening Portal...");
            setTimeout(() => { window.location.href = "https://userspotral.vercel.app/"; }, 1000);
        }
    </script>
</body>
</html>
